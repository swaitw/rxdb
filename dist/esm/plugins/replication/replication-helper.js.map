{"version":3,"file":"replication-helper.js","names":["flatClone","getComposedPrimaryKeyOfDocumentData","DEFAULT_MODIFIER","d","Promise","resolve","swapDefaultDeletedTodeletedField","deletedField","doc","isDeleted","_deleted","handlePulledDocuments","collection","docs","map","useDoc","primaryPath","schema","jsonSchema","awaitRetry","retryTime","window","addEventListener","navigator","onLine","promiseWait","listener","onlineAgain","res","removeEventListener","race","then","preventHibernateBrowserTab","replicationState","simulateActivity","document","dispatchEvent","event","Event","intervalId","setInterval","onCancel","push","clearInterval"],"sources":["../../../../src/plugins/replication/replication-helper.ts"],"sourcesContent":["import type {\n    RxCollection,\n    WithDeleted\n} from '../../types/index.d.ts';\nimport { flatClone } from '../../plugins/utils/index.ts';\nimport { getComposedPrimaryKeyOfDocumentData } from '../../rx-schema-helper.ts';\nimport type { RxReplicationState } from './index.ts';\n\n// does nothing\nexport const DEFAULT_MODIFIER = (d: any) => Promise.resolve(d);\n\n\nexport function swapDefaultDeletedTodeletedField<RxDocType>(\n    deletedField: string,\n    doc: WithDeleted<RxDocType>\n): RxDocType {\n    if (deletedField === '_deleted') {\n        return doc;\n    } else {\n        doc = flatClone(doc);\n        const isDeleted = !!doc._deleted;\n        (doc as any)[deletedField] = isDeleted;\n        delete (doc as any)._deleted;\n        return doc;\n    }\n}\n\n/**\n * Must be run over all plain document data\n * that was pulled from the remote.\n * Used to fill up fields or modify the deleted field etc.\n */\nexport function handlePulledDocuments<RxDocType>(\n    collection: RxCollection<RxDocType>,\n    deletedField: string,\n    docs: RxDocType[]\n): WithDeleted<RxDocType>[] {\n    return docs.map(doc => {\n        const useDoc: WithDeleted<RxDocType> = flatClone(doc) as any;\n\n        /**\n         * Swap out the deleted field\n         */\n        if (deletedField !== '_deleted') {\n            const isDeleted = !!(useDoc as any)[deletedField];\n            (useDoc as any)._deleted = isDeleted;\n            delete (useDoc as any)[deletedField];\n        } else {\n            // ensure we have a boolean.\n            useDoc._deleted = !!useDoc._deleted;\n        }\n\n        /**\n         * Fill up composed primary\n         */\n        const primaryPath = collection.schema.primaryPath;\n        (useDoc as any)[primaryPath] = getComposedPrimaryKeyOfDocumentData(\n            collection.schema.jsonSchema,\n            useDoc\n        );\n        return useDoc as any;\n    });\n}\n\n\n/**\n * Like normal promiseWait()\n * but will skip the wait time if the online-state changes.\n */\nexport function awaitRetry(\n    collection: RxCollection,\n    retryTime: number\n) {\n    if (\n        typeof window === 'undefined' ||\n        typeof window !== 'object' ||\n        typeof window.addEventListener === 'undefined' ||\n        navigator.onLine\n    ) {\n        return collection.promiseWait(retryTime);\n    }\n\n    let listener: any;\n    const onlineAgain = new Promise<void>(res => {\n        listener = () => {\n            window.removeEventListener('online', listener);\n            res();\n        };\n        window.addEventListener('online', listener);\n    });\n\n    return Promise.race([\n        onlineAgain,\n        collection.promiseWait(retryTime)\n    ]).then(() => {\n        window.removeEventListener('online', listener);\n    });\n}\n\n\n/**\n * When a replication is running and the leading tab get hibernated\n * by the browser, the replication will be stuck.\n * To prevent this, we fire a mouseeven each X seconds while the replication is not canceled.\n * \n * If you find a better way to prevent hibernation, please make a pull request.\n */\nexport function preventHibernateBrowserTab(replicationState: RxReplicationState<any, any>) {\n    function simulateActivity() {\n        if (\n            typeof document === 'undefined' ||\n            typeof document.dispatchEvent !== 'function'\n        ) {\n            return;\n        }\n        const event = new Event('mousemove');\n        document.dispatchEvent(event);\n    }\n\n    const intervalId = setInterval(simulateActivity, 20 * 1000); // Simulate activity every 20 seconds\n    replicationState.onCancel.push(() => clearInterval(intervalId));\n}\n"],"mappings":"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","ignoreList":[]}